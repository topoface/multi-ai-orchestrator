name: Knowledge Update

on:
  schedule:
    # Run daily at midnight UTC
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  update-knowledge:
    name: Update knowledge from Vertex AI
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Pull updates from Vertex AI
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ github.workspace }}/sa-key.json
          GCP_PROJECT_ID: phsysics
        run: |
          # Create service account key file
          echo '${{ secrets.GCP_SA_KEY }}' > sa-key.json

          # Sync from Vertex AI to GitHub
          python .claude/skills/github-sync/sync_manager.py --from-vertex

      - name: Check for changes
        id: check-changes
        run: |
          if [ -n "$(git status --porcelain docs/brain/)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit updates
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          git config user.name "Multi-AI Bot"
          git config user.email "bot@multi-ai-orchestrator"

          git add docs/brain/
          git commit -m "chore: Update knowledge from Vertex AI ($(date -u +%Y-%m-%d))"

      - name: Push changes
        if: steps.check-changes.outputs.has_changes == 'true'
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: main

      - name: Report status
        run: |
          if [ "${{ steps.check-changes.outputs.has_changes }}" == "true" ]; then
            echo "✅ Knowledge updated from Vertex AI"
          else
            echo "ℹ️ No updates needed"
          fi

  cleanup-old-debates:
    name: Cleanup old debate files
    runs-on: ubuntu-latest
    needs: update-knowledge

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Remove old debate JSON files
        run: |
          # Keep only last 30 debate files
          cd docs/brain/
          ls -t debate_*.json 2>/dev/null | tail -n +31 | xargs -r rm

      - name: Check for changes
        id: check-changes
        run: |
          if [ -n "$(git status --porcelain docs/brain/)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit cleanup
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          git config user.name "Multi-AI Bot"
          git config user.email "bot@multi-ai-orchestrator"

          git add docs/brain/
          git commit -m "chore: Cleanup old debate files"

      - name: Push changes
        if: steps.check-changes.outputs.has_changes == 'true'
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: main

  quality-report:
    name: Generate quality report
    runs-on: ubuntu-latest
    needs: update-knowledge

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Generate quality metrics
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ github.workspace }}/sa-key.json
        run: |
          # Create service account key file
          echo '${{ secrets.GCP_SA_KEY }}' > sa-key.json

          # Generate quality report
          python .claude/agents/vertex-learner/vertex_learner.py monitor-quality > quality_report.txt

      - name: Display report
        run: |
          echo "## Knowledge Base Quality Report"
          echo "Date: $(date -u)"
          echo ""
          cat quality_report.txt
